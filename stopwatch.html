<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Attentionâ€”Spanâ€”Tracker - è®¡æ—¶</title>
    
    <!-- PWA Metaæ ‡ç­¾ -->
    <meta name="description" content="å¤šæ´»åŠ¨ç‹¬ç«‹è®¡æ—¶å™¨åº”ç”¨ï¼Œæ”¯æŒå¹¶è¡Œè®¡æ—¶å’Œè¯¦ç»†ç»Ÿè®¡">
    <meta name="theme-color" content="#0A0A0A">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Attentionâ€”Spanâ€”Tracker">
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="/manifest.json">
    
    <!-- å›¾æ ‡ -->
    <link rel="icon" type="image/jpeg" href="assets/æ—¶é—´ç®¡é“.JPG">
    <link rel="apple-touch-icon" href="assets/æ—¶é—´ç®¡é“.JPG">
    <link rel="icon" type="image/jpeg" sizes="32x32" href="assets/æ—¶é—´ç®¡é“.JPG">
    <link rel="icon" type="image/jpeg" sizes="16x16" href="assets/æ—¶é—´ç®¡é“.JPG">
    
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;500;700&family=Rajdhani:wght@300;400;500;600&family=Exo+2:wght@200;300;400;500;600&family=Titillium+Web:wght@200;300;400;600&display=swap" rel="stylesheet">
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            background-color: #0A0A0A;
            color: #FFFFFF;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            height: 100vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        /* æ ‡é¢˜æ  */
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px;
            border-bottom: 1px solid #333;
        }

        .activity-title {
            font-family: 'Orbitron', 'Rajdhani', 'Exo 2', 'Titillium Web', 'Source Sans Pro', sans-serif;
            font-size: 24px;
            font-weight: 500;
            color: #FFFFFF;
            letter-spacing: 4px;
            text-transform: uppercase;
            text-shadow: 0 0 8px rgba(255, 255, 255, 0.3);
        }

        .header-controls {
            display: flex;
            gap: 15px;
            align-items: center;
        }

        .back-btn, .switch-btn {
            background: #333;
            border: none;
            color: #FFFFFF;
            padding: 10px 15px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            transition: background-color 0.3s;
        }

        .back-btn:hover, .switch-btn:hover {
            background: #555;
        }

        /* ä¸»æ˜¾ç¤ºåŒº */
        .main-display {
            flex: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 40px 20px;
        }

        .time-display {
            font-size: 4rem;
            font-weight: 300;
            font-family: 'SF Mono', Monaco, 'Cascadia Code', monospace;
            color: #FFFFFF;
            text-align: center;
            margin-bottom: 40px;
            letter-spacing: 0.1em;
        }

        /* æŒ‰é’®åŒºåŸŸ */
        .button-area {
            display: flex;
            gap: 20px;
            margin-bottom: 40px;
            justify-content: center;
        }

        .control-btn {
            padding: 15px 30px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            min-width: 120px;
            height: 50px;
        }

        /* ä¸»ç•Œé¢é£æ ¼çš„æŒ‰é’®æ ·å¼ */
        .control-btn.primary {
            background-color: #4CAF50;
            color: #FFFFFF;
        }

        .control-btn.primary:hover {
            background-color: #45a049;
        }

        .control-btn.secondary {
            background-color: #666;
            color: #FFFFFF;
        }

        .control-btn.secondary:hover {
            background-color: #777;
        }

        .control-btn.danger {
            background-color: #f44336;
            color: #FFFFFF;
        }

        .control-btn.danger:hover {
            background-color: #da190b;
        }

        /* æŒ‰é’®åˆå§‹éšè—æ ·å¼ */
        .btn-hidden {
            display: none !important;
            visibility: hidden !important;
            opacity: 0 !important;
        }



        /* Lap åˆ—è¡¨ */
        .lap-container {
            flex: 1;
            background-color: #111;
            border-radius: 20px 20px 0 0;
            padding: 20px;
            overflow-y: auto;
            margin: 0 20px;
        }

        .lap-header {
            display: flex;
            justify-content: space-between;
            padding: 0 20px 15px;
            border-bottom: 1px solid #333;
            margin-bottom: 15px;
            font-weight: bold;
            color: #999;
        }

        .lap-item {
            display: flex;
            justify-content: space-between;
            padding: 15px 20px;
            border-bottom: 1px solid #222;
            align-items: center;
        }

        .lap-item:last-child {
            border-bottom: none;
        }

        .lap-number {
            font-weight: bold;
            color: #FFFFFF;
            min-width: 80px;
        }

        .lap-split {
            font-family: 'SF Mono', Monaco, 'Cascadia Code', monospace;
            color: #999;
            min-width: 120px;
            text-align: center;
        }

        .lap-total {
            font-family: 'SF Mono', Monaco, 'Cascadia Code', monospace;
            color: #FFFFFF;
            min-width: 120px;
            text-align: right;
        }

        /* çŠ¶æ€æŒ‡ç¤ºå™¨ */
        .status-indicator {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            margin-left: 10px;
        }

        .status-running {
            background-color: #4CAF50;
        }

        .status-paused {
            background-color: #FF9800;
        }

        .status-stopped {
            background-color: #666;
        }



        /* å“åº”å¼è®¾è®¡ */
        @media (max-width: 768px) {
            .time-display {
                font-size: 3rem;
            }
            
            .control-btn {
                min-width: 100px;
                height: 45px;
                font-size: 14px;
                padding: 10px 20px;
            }
            
            .button-area {
                gap: 15px;
            }

            .lap-btn {
                min-width: 100px;
                height: 45px;
                font-size: 14px;
                padding: 10px 20px;
            }
        }

        @media (max-width: 600px) {
            .button-area {
                flex-wrap: wrap;
                justify-content: center;
                gap: 10px;
            }

            .control-btn {
                min-width: 90px;
                font-size: 14px;
                padding: 12px 20px;
            }
        }

        @media (max-width: 480px) {
            .button-area {
                flex-direction: column;
                align-items: center;
                gap: 12px;
            }

            .control-btn {
                width: 180px;
                height: 48px;
                font-size: 16px;
            }
        }
    </style>
</head>
<body>
    <!-- æ ‡é¢˜æ  -->
    <div class="header">
        <div class="activity-title" id="activity-title">
            æ´»åŠ¨åç§°
            <span class="status-indicator" id="status-indicator"></span>
        </div>
        <div class="header-controls">
            <select class="switch-btn" id="activity-switcher">
                <option value="">åˆ‡æ¢æ´»åŠ¨</option>
            </select>
            <button class="back-btn" id="back-btn" onclick="goBack()">è¿”å›</button>
        </div>
    </div>

    <!-- ä¸»æ˜¾ç¤ºåŒº -->
    <div class="main-display">
        <div class="time-display" id="time-display">00:00:00.00</div>
        
        <!-- æŒ‰é’®åŒºåŸŸ -->
        <div class="button-area">
            <button class="control-btn btn-hidden" id="btn-1"></button>
            <button class="control-btn btn-hidden" id="btn-2"></button>
            <button class="control-btn btn-hidden" id="btn-3"></button>
            <button class="control-btn btn-hidden" id="btn-4"></button>
        </div>
    </div>

    <!-- Lap åˆ—è¡¨ -->
    <div class="lap-container">
        <div class="lap-header">
            <span>Lap No.</span>
            <span>Split</span>
            <span>Total</span>
        </div>
        <div id="lap-list">
            <!-- Lap è®°å½•å°†åœ¨è¿™é‡ŒåŠ¨æ€æ·»åŠ  -->
        </div>
    </div>

    <script>
        // ä»URLè·å–æ´»åŠ¨åç§°
        function getActivityName() {
            const params = new URLSearchParams(window.location.search);
            return params.get('activity') || 'é»˜è®¤æ´»åŠ¨';
        }

        // å¼•å…¥ä¸»ç•Œé¢çš„ç®¡ç†å™¨è„šæœ¬
        const script = document.createElement('script');
        script.src = 'multi-stopwatch.js';
        document.head.appendChild(script);

        // ä½¿ç”¨å…¨å±€çš„MultiStopwatchManagerï¼Œç¡®ä¿æ•°æ®ä¸€è‡´æ€§
        let manager = null;
        let currentActivity = getActivityName();
        let updateInterval = null;
        let isInitialized = false;

        // DOM å…ƒç´ 
        const activityTitle = document.getElementById('activity-title');
        const timeDisplay = document.getElementById('time-display');
        const buttonArea = document.querySelector('.button-area');
        const lapList = document.getElementById('lap-list');
        const statusIndicator = document.getElementById('status-indicator');
        const activitySwitcher = document.getElementById('activity-switcher');

        // åˆå§‹åŒ–ç®¡ç†å™¨ï¼ˆä½¿ç”¨ä¸»ç•Œé¢çš„ç®¡ç†å™¨ç±»ï¼‰
        function initManager() {
            return new Promise((resolve) => {
                // ç­‰å¾…ä¸»ç•Œé¢è„šæœ¬åŠ è½½å®Œæˆ
                if (typeof MultiStopwatchManager !== 'undefined') {
                    manager = new MultiStopwatchManager();
                    console.log('âœ… ä½¿ç”¨ä¸»ç•Œé¢çš„MultiStopwatchManagerå®ä¾‹');
                    
                    // ç¡®ä¿æ•°æ®å®Œå…¨åŠ è½½
                    setTimeout(() => {
                        if (manager.getTimer && manager.getTimer(currentActivity)) {
                            console.log(`âœ… è®¡æ—¶å™¨"${currentActivity}"æ•°æ®å·²å°±ç»ª`);
                            resolve(true);
                        } else {
                            console.log(`âš ï¸ è®¡æ—¶å™¨"${currentActivity}"æ•°æ®æœªå°±ç»ªï¼Œåˆ›å»ºæ–°çš„è®¡æ—¶å™¨`);
                            // å¦‚æœè®¡æ—¶å™¨ä¸å­˜åœ¨ï¼Œåˆ›å»ºä¸€ä¸ªæ–°çš„
                            manager.getTimer(currentActivity); // è¿™ä¼šè‡ªåŠ¨åˆ›å»ºè®¡æ—¶å™¨
                            resolve(true);
                        }
                    }, 50);
                } else {
                    // å¦‚æœä¸»ç•Œé¢è„šæœ¬è¿˜æœªåŠ è½½ï¼Œå»¶è¿Ÿåˆå§‹åŒ–
                    setTimeout(() => {
                        initManager().then(resolve);
                    }, 100);
                }
            });
        }

        // ä»…æ›´æ–°æ—¶é—´æ˜¾ç¤ºï¼ˆä¸è§¦åŠæŒ‰é’®ï¼‰
        function updateTimeDisplay() {
            if (!manager) return;
            
            const timer = manager.getTimer(currentActivity);
            if (!timer) return;
            
            // è·å–å½“å‰æ—¶é—´ - ä½¿ç”¨ä¸»ç•Œé¢ç›¸åŒçš„æ–¹æ³•
            const currentTime = manager.getCurrentTime(currentActivity);
            
            // ä½¿ç”¨ä¸»ç•Œé¢çš„æ ¼å¼åŒ–å‡½æ•°ï¼Œç¡®ä¿æ˜¾ç¤ºä¸€è‡´
            const formattedTime = manager.formatTime ? manager.formatTime(currentTime) : formatTimeLocal(currentTime);
            
            // æ›´æ–°æ—¶é—´æ˜¾ç¤º
            if (timeDisplay) {
                timeDisplay.textContent = formattedTime;
            }
            
            // æ›´æ–°çŠ¶æ€æŒ‡ç¤ºå™¨
            if (statusIndicator) {
                statusIndicator.className = 'status-indicator';
                if (timer.isRunning) {
                    statusIndicator.classList.add('status-running');
                } else if (timer.elapsedTime > 0) {
                    statusIndicator.classList.add('status-paused');
                } else {
                    statusIndicator.classList.add('status-stopped');
                }
            }
        }
        
        // æ›´æ–°æ˜¾ç¤ºï¼ˆåŒ…æ‹¬æŒ‰é’®ï¼‰
        function updateDisplay() {
            if (!manager) return;
            
            const timer = manager.getTimer(currentActivity);
            if (!timer) return;
            
            // æ›´æ–°æ—¶é—´æ˜¾ç¤º
            updateTimeDisplay();
            
            // ç²¾ç®€è°ƒè¯•ä¿¡æ¯ï¼ˆä»…åœ¨å¼€å§‹/åœæ­¢æ—¶è¾“å‡ºï¼‰
            if (timer.isRunning && !updateDisplay.wasRunning) {
                console.log(`â° å¼€å§‹è®¡æ—¶: ${currentActivity}`);
                updateDisplay.wasRunning = true;
            } else if (!timer.isRunning && updateDisplay.wasRunning) {
                const formattedTime = manager.formatTime ? manager.formatTime(manager.getCurrentTime(currentActivity)) : formatTimeLocal(manager.getCurrentTime(currentActivity));
                console.log(`â° åœæ­¢è®¡æ—¶: ${currentActivity} - æ€»æ—¶é—´: ${formattedTime}`);
                updateDisplay.wasRunning = false;
            }
            
            // æ›´æ–°æŒ‰é’®çŠ¶æ€
            updateButtons();
            
            // æ›´æ–°Lapåˆ—è¡¨
            updateLapList();
        }

        // æœ¬åœ°æ—¶é—´æ ¼å¼åŒ–å‡½æ•°ï¼ˆå¤‡ç”¨ï¼‰- ä¸ä¸»ç•Œé¢å®Œå…¨ä¸€è‡´
        function formatTimeLocal(milliseconds) {
            const totalSeconds = Math.floor(milliseconds / 1000);
            const hours = Math.floor(totalSeconds / 3600);
            const minutes = Math.floor((totalSeconds % 3600) / 60);
            const seconds = totalSeconds % 60;
            const ms = Math.floor((milliseconds % 1000) / 10);

            if (hours > 0) {
                return `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}.${ms.toString().padStart(2, '0')}`;
            } else {
                return `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}.${ms.toString().padStart(2, '0')}`;
            }
        }

        // ä½¿ç”¨ä¸»ç•Œé¢ç›¸åŒçš„æŒ‰é’®ç”Ÿæˆé€»è¾‘
        function getActionButtons(timer) {
            if (timer.isRunning) {
                return `
                    <button class="control-btn secondary" data-action="stop">æš‚åœ</button>
                    <button class="control-btn primary" data-action="lap">åˆ†æ®µ</button>
                    <button class="control-btn primary" data-action="complete">å®Œæˆ</button>
                `;
            } else if (timer.elapsedTime > 0) {
                return `
                    <button class="control-btn primary" data-action="start">ç»§ç»­</button>
                    <button class="control-btn primary" data-action="complete">å®Œæˆ</button>
                    <button class="control-btn secondary" data-action="reset">é‡ç½®</button>
                    <button class="control-btn danger" data-action="delete">åˆ é™¤</button>
                `;
            } else {
                return `
                    <button class="control-btn primary" data-action="start">å¼€å§‹</button>
                    <button class="control-btn danger" data-action="delete">åˆ é™¤</button>
                `;
            }
        }

        // æ·»åŠ æŒ‰é’®äº‹ä»¶ç›‘å¬å™¨ - ä¸ä¸»ç•Œé¢é€»è¾‘ä¸€è‡´
        function addButtonListeners() {
            const buttons = buttonArea.querySelectorAll('.control-btn');
            console.log(`ğŸ”— ç»‘å®šäº‹ä»¶åˆ° ${buttons.length} ä¸ªæŒ‰é’®`);
            
            buttons.forEach((button, index) => {
                const action = button.dataset.action;
                console.log(`æŒ‰é’® ${index + 1}: ${button.textContent} -> ${action}`);
                
                // ç§»é™¤æ—§çš„äº‹ä»¶ç›‘å¬å™¨
                button.removeEventListener('click', handleButtonClick);
                
                // æ·»åŠ æ–°çš„äº‹ä»¶ç›‘å¬å™¨
                button.addEventListener('click', handleButtonClick);
            });
        }

        // ç»Ÿä¸€çš„æŒ‰é’®ç‚¹å‡»å¤„ç†å‡½æ•°
        function handleButtonClick(e) {
            e.preventDefault();
            e.stopPropagation();
            
            const button = e.target;
            const action = button.dataset.action;
            const buttonText = button.textContent;
            
            console.log(`ğŸ”˜ æŒ‰é’®ç‚¹å‡» - æ–‡æœ¬: "${buttonText}", æ“ä½œ: "${action}", æ´»åŠ¨: "${currentActivity}"`);
            
            if (!action) {
                console.error('âŒ æŒ‰é’®ç¼ºå°‘actionå±æ€§');
                return;
            }
            
            // æ·»åŠ ç‚¹å‡»è§†è§‰åé¦ˆ
            button.style.transform = 'scale(0.98)';
            setTimeout(() => {
                button.style.transform = '';
            }, 100);
            
            handleButtonAction(action);
        }

        // æ›´æ–°æŒ‰é’®çŠ¶æ€ - ä¸ä¸»ç•Œé¢é€»è¾‘å®Œå…¨ä¸€è‡´
        function updateButtons() {
            if (!manager) return;
            
            const timer = manager.getTimer(currentActivity);
            if (!timer) return;
            
            // ç¡®å®šå½“å‰çŠ¶æ€
            let newState;
            if (timer.isRunning) {
                newState = 'running';
            } else if (timer.elapsedTime > 0) {
                newState = 'paused';
            } else {
                newState = 'initial';
            }
            
            // é¿å…é‡å¤æ›´æ–°ç›¸åŒçŠ¶æ€
            if (updateButtons.lastState === newState) {
                return;
            }
            updateButtons.lastState = newState;
            
            console.log(`ğŸ”„ æ›´æ–°æŒ‰é’®çŠ¶æ€: ${updateButtons.lastState} â†’ ${newState}`);
            
            // ä½¿ç”¨ä¸»ç•Œé¢ç›¸åŒçš„æŒ‰é’®ç”Ÿæˆé€»è¾‘
            buttonArea.innerHTML = getActionButtons(timer);
            
            // ç»‘å®šæŒ‰é’®äº‹ä»¶
            addButtonListeners();
            
            console.log('âœ… æŒ‰é’®çŠ¶æ€æ›´æ–°å®Œæˆ');
        }

        // æ›´æ–°Lapåˆ—è¡¨
        function updateLapList() {
            if (!manager) return;
            
            const timer = manager.getTimer(currentActivity);
            lapList.innerHTML = '';
            
            // å€’åºæ˜¾ç¤ºLapï¼ˆæœ€æ–°çš„åœ¨å‰é¢ï¼‰
            if (timer.laps && timer.laps.length > 0) {
                timer.laps.slice().reverse().forEach(lap => {
                    const lapItem = document.createElement('div');
                    lapItem.className = 'lap-item';
                    lapItem.innerHTML = `
                        <span class="lap-number">Lap ${lap.number}</span>
                        <span class="lap-split">${manager.formatTime ? manager.formatTime(lap.split) : formatTimeLocal(lap.split)}</span>
                        <span class="lap-total">${manager.formatTime ? manager.formatTime(lap.total) : formatTimeLocal(lap.total)}</span>
                    `;
                    lapList.appendChild(lapItem);
                });
            }
        }

        // æ›´æ–°æ´»åŠ¨åˆ‡æ¢å™¨
        function updateActivitySwitcher() {
            if (!manager) return;
            
            const activities = manager.getAllActivities();
            activitySwitcher.innerHTML = '<option value="">åˆ‡æ¢æ´»åŠ¨</option>';
            
            activities.forEach(activity => {
                if (activity !== currentActivity) {
                    const option = document.createElement('option');
                    option.value = activity;
                    option.textContent = activity;
                    activitySwitcher.appendChild(option);
                }
            });
        }

        // ä½¿ç”¨ä¸»ç•Œé¢ç›¸åŒçš„æŒ‰é’®å¤„ç†é€»è¾‘
        function handleButtonAction(action) {
            console.log(`ğŸš€ å¼€å§‹æ‰§è¡Œæ“ä½œ: "${action}"`);
            
            if (!manager) {
                console.error('âŒ Manageræœªåˆå§‹åŒ–');
                showNotification('ç®¡ç†å™¨æœªåˆå§‹åŒ–ï¼Œè¯·åˆ·æ–°é¡µé¢');
                return;
            }
            
            const timer = manager.getTimer(currentActivity);
            if (!timer) {
                console.error('âŒ è®¡æ—¶å™¨æœªæ‰¾åˆ°');
                showNotification('è®¡æ—¶å™¨æœªæ‰¾åˆ°ï¼Œè¯·åˆ·æ–°é¡µé¢');
                return;
            }
            
            console.log(`ğŸ“Š æ“ä½œå‰çŠ¶æ€ - è¿è¡Œ: ${timer.isRunning}, æ—¶é—´: ${timer.elapsedTime}ms, Laps: ${timer.laps?.length || 0}`);
            
            const oldRunningState = timer.isRunning;
            const oldElapsedTime = timer.elapsedTime;
            
            try {
                switch (action) {
                    case 'start':
                        console.log('â–¶ï¸ æ‰§è¡Œå¼€å§‹æ“ä½œ');
                        manager.start(currentActivity);
                        showNotification(`"${currentActivity}" å·²å¼€å§‹è®¡æ—¶`);
                        break;
                        
                    case 'stop':
                        console.log('â¸ï¸ æ‰§è¡Œæš‚åœæ“ä½œ');
                        manager.stop(currentActivity);
                        showNotification(`"${currentActivity}" å·²æš‚åœ`);
                        break;
                        
                    case 'lap':
                        console.log('ğŸ æ‰§è¡Œåˆ†æ®µæ“ä½œ');
                        manager.addLap(currentActivity);
                        const lapNumber = timer.laps?.length || 0;
                        showNotification(`å·²æ·»åŠ ç¬¬ ${lapNumber} ä¸ªåˆ†æ®µ`);
                        break;
                        
                    case 'complete':
                        if (confirm(`ç¡®å®šè¦å®Œæˆ"${currentActivity}"æ´»åŠ¨å—ï¼Ÿè¿™å°†ä¿å­˜æ´»åŠ¨è®°å½•å¹¶é‡ç½®è®¡æ—¶å™¨ã€‚`)) {
                            console.log('âœ… æ‰§è¡Œå®Œæˆæ“ä½œ');
                            manager.completeActivityAndReset(currentActivity);
                            showNotification(`"${currentActivity}" æ´»åŠ¨å·²å®Œæˆå¹¶ä¿å­˜`);
                        } else {
                            console.log('âŒ ç”¨æˆ·å–æ¶ˆå®Œæˆæ“ä½œ');
                            return;
                        }
                        break;
                        
                    case 'reset':
                        if (confirm(`ç¡®å®šè¦é‡ç½®"${currentActivity}"çš„è®¡æ—¶å™¨å—ï¼Ÿè¿™å°†æ¸…é™¤å½“å‰è®¡æ—¶æ•°æ®ã€‚`)) {
                            console.log('ğŸ”„ æ‰§è¡Œé‡ç½®æ“ä½œ');
                            manager.reset(currentActivity);
                            showNotification(`"${currentActivity}" è®¡æ—¶å™¨å·²é‡ç½®`);
                        } else {
                            console.log('âŒ ç”¨æˆ·å–æ¶ˆé‡ç½®æ“ä½œ');
                            return;
                        }
                        break;
                        
                    case 'delete':
                        if (confirm(`ç¡®å®šè¦åˆ é™¤"${currentActivity}"è®¡æ—¶å™¨å—ï¼Ÿåˆ é™¤åå°†æ— æ³•æ¢å¤ã€‚`)) {
                            console.log('ğŸ—‘ï¸ æ‰§è¡Œåˆ é™¤æ“ä½œ');
                            manager.delete(currentActivity);
                            showNotification(`"${currentActivity}" è®¡æ—¶å™¨å·²åˆ é™¤`);
                            // è¿”å›ä¸»é¡µ
                            setTimeout(() => {
                                window.location.href = 'index.html';
                            }, 1000);
                            return;
                        } else {
                            console.log('âŒ ç”¨æˆ·å–æ¶ˆåˆ é™¤æ“ä½œ');
                            return;
                        }
                        break;
                        
                    default:
                        console.error(`âŒ æœªçŸ¥æ“ä½œ: ${action}`);
                        showNotification(`æœªçŸ¥æ“ä½œ: ${action}`);
                        return;
                }
                
                // éªŒè¯æ“ä½œç»“æœ
                const newTimer = manager.getTimer(currentActivity);
                if (newTimer) {
                    console.log(`ğŸ“Š æ“ä½œåçŠ¶æ€ - è¿è¡Œ: ${newTimer.isRunning}, æ—¶é—´: ${newTimer.elapsedTime}ms, Laps: ${newTimer.laps?.length || 0}`);
                }
                
                // ç«‹å³æ›´æ–°æ˜¾ç¤º
                updateTimeDisplay();
                updateLapList();
                
                // æ£€æŸ¥è¿è¡ŒçŠ¶æ€å˜åŒ–
                const newRunningState = newTimer.isRunning;
                if (oldRunningState !== newRunningState) {
                    console.log(`ğŸ”„ è¿è¡ŒçŠ¶æ€æ”¹å˜: ${oldRunningState} â†’ ${newRunningState}ï¼Œé‡å¯æ›´æ–°å¾ªç¯`);
                    startUpdateLoop();
                }
                
                // æ›´æ–°æŒ‰é’®çŠ¶æ€
                setTimeout(() => {
                    updateButtons();
                }, 50);
                
                console.log(`âœ… æ“ä½œ "${action}" æ‰§è¡Œå®Œæˆ`);
                
            } catch (error) {
                console.error(`âŒ æ‰§è¡Œæ“ä½œ "${action}" æ—¶å‡ºé”™:`, error);
                showNotification(`æ‰§è¡Œæ“ä½œå¤±è´¥: ${error.message}`);
            }
        }

        // æ˜¾ç¤ºé€šçŸ¥
        function showNotification(message) {
            const notification = document.createElement('div');
            notification.className = 'notification';
            notification.textContent = message;
            
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: #4CAF50;
                color: white;
                padding: 12px 20px;
                border-radius: 6px;
                font-size: 14px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.3);
                z-index: 10000;
                animation: slideInRight 0.3s ease-out;
            `;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.style.animation = 'slideOutRight 0.3s ease-in';
                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.parentNode.removeChild(notification);
                    }
                }, 300);
            }, 2000);
        }



        // æ´»åŠ¨åˆ‡æ¢
        function handleActivitySwitch(e) {
            if (e.target.value) {
                window.location.href = `stopwatch.html?activity=${encodeURIComponent(e.target.value)}`;
            }
        }

        // è¿”å›ä¸»é¡µ
        function goBack() {
            window.location.href = 'index.html';
        }

        // å¼€å§‹æ›´æ–°å¾ªç¯
        function startUpdateLoop() {
            // æ¸…é™¤ç°æœ‰çš„æ›´æ–°å¾ªç¯
            if (updateInterval) {
                clearInterval(updateInterval);
                updateInterval = null;
            }
            
            if (!manager) return;
            
            // è·å–å½“å‰è®¡æ—¶å™¨çŠ¶æ€
            const timer = manager.getTimer(currentActivity);
            if (!timer) return;
            
            // ç»Ÿä¸€ä½¿ç”¨100msæ›´æ–°é—´éš”ï¼Œä¸ä¸»ç•Œé¢ä¿æŒä¸€è‡´
            const interval = timer.isRunning ? 100 : 1000;
            
            console.log(`ğŸ”„ å¯åŠ¨æ›´æ–°å¾ªç¯: æ´»åŠ¨="${currentActivity}", è¿è¡ŒçŠ¶æ€=${timer.isRunning}, æ›´æ–°é—´éš”=${interval}ms`);
            
            // ç«‹å³æ‰§è¡Œä¸€æ¬¡æ—¶é—´æ›´æ–°ï¼ˆé¿å…è§¦åŠæŒ‰é’®ï¼‰
            updateTimeDisplay();
            updateLapList();
            
            // è®¾ç½®æ–°çš„æ›´æ–°å¾ªç¯ - ä»…æ›´æ–°æ—¶é—´æ˜¾ç¤ºï¼Œé¿å…é¢‘ç¹æ›´æ–°æŒ‰é’®
            updateInterval = setInterval(() => {
                try {
                    updateTimeDisplay();
                    updateLapList();
                } catch (error) {
                    console.error('âŒ æ›´æ–°æ˜¾ç¤ºæ—¶å‡ºé”™:', error);
                }
            }, interval);
            
            // è®¾ç½®çŠ¶æ€ç›‘å¬å™¨ï¼Œåªåœ¨çŠ¶æ€çœŸæ­£æ”¹å˜æ—¶é‡å¯å¾ªç¯
            startUpdateLoop.lastRunningState = timer.isRunning;
        }

        // å¼ºåˆ¶éšè—æŒ‰é’®å‡½æ•°
        function forceHideButtons() {
            // æ¸…ç©ºæŒ‰é’®åŒºåŸŸ
            buttonArea.innerHTML = '';
            console.log('ğŸ”’ å¼ºåˆ¶éšè—æ‰€æœ‰æŒ‰é’®');
        }

        // åˆå§‹åŒ–
        function init() {
            console.log('ğŸš€ å¼€å§‹åˆå§‹åŒ–stopwatché¡µé¢...');
            
            // é˜²æ­¢é‡å¤åˆå§‹åŒ–
            if (isInitialized) {
                console.log('âš ï¸ é¡µé¢å·²ç»åˆå§‹åŒ–è¿‡ï¼Œè·³è¿‡');
                return;
            }
            
            // éªŒè¯DOMå…ƒç´ 
            if (!timeDisplay) {
                console.error('timeDisplayå…ƒç´ æœªæ‰¾åˆ°ï¼');
                return;
            }
            if (!buttonArea) {
                console.error('æŒ‰é’®åŒºåŸŸæœªæ‰¾åˆ°ï¼');
                return;
            }
            
            // ç«‹å³å¼ºåˆ¶éšè—æ‰€æœ‰æŒ‰é’® - ä½¿ç”¨æœ€å¼ºåˆ¶çš„æ–¹å¼
            forceHideButtons();
            
            // è®¾ç½®æ´»åŠ¨æ ‡é¢˜
            activityTitle.textContent = currentActivity;
            
            // åˆå§‹åŒ–ç®¡ç†å™¨
            initManager().then(() => {
                // éªŒè¯ç®¡ç†å™¨
                const timer = manager.getTimer(currentActivity);
                if (!timer) {
                    console.error(`è®¡æ—¶å™¨"${currentActivity}"æœªæ‰¾åˆ°ï¼`);
                    return;
                }
                
                console.log(`âœ… è®¡æ—¶å™¨çŠ¶æ€ç¡®è®¤: è¿è¡Œ=${timer.isRunning}, æ—¶é—´=${timer.elapsedTime}ms`);
                
                // ç»‘å®šäº‹ä»¶ç›‘å¬å™¨
                activitySwitcher.addEventListener('change', handleActivitySwitch);
                
                // åˆå§‹åŒ–å…¶ä»–æ˜¾ç¤ºå†…å®¹ï¼ˆä½†ä¸åŒ…æ‹¬æŒ‰é’®ï¼‰
                updateTimeDisplay();
                updateLapList();
                updateActivitySwitcher();
                
                console.log('â³ ç­‰å¾…200msåæ˜¾ç¤ºæŒ‰é’®...');
                
                // å»¶è¿Ÿè¶³å¤Ÿé•¿çš„æ—¶é—´ï¼Œç¡®ä¿æ‰€æœ‰åˆå§‹åŒ–å®Œæˆ
                setTimeout(() => {
                    // ç°åœ¨å®‰å…¨åœ°æ›´æ–°æŒ‰é’®
                    updateButtons();
                    console.log('ğŸ¯ æŒ‰é’®çŠ¶æ€è®¾ç½®å®Œæˆï¼Œå¯åŠ¨æ›´æ–°å¾ªç¯');
                    
                    // å¼€å§‹æ›´æ–°å¾ªç¯
                    startUpdateLoop();
                    
                    // æ ‡è®°åˆå§‹åŒ–å®Œæˆ
                    isInitialized = true;
                    console.log('ğŸ“± Stopwatché¡µé¢åˆå§‹åŒ–å®Œæˆ');
                }, 200);
            }).catch((error) => {
                console.error('âŒ åˆå§‹åŒ–å¤±è´¥:', error);
            });
        }

        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        window.addEventListener('load', init);

        // é¡µé¢å¸è½½æ—¶æ¸…ç†
        window.addEventListener('beforeunload', () => {
            if (updateInterval) {
                clearInterval(updateInterval);
            }
        });

        // ç›‘å¬å­˜å‚¨å˜åŒ–ï¼Œç¡®ä¿ä¸ä¸»ç•Œé¢åŒæ­¥
        window.addEventListener('storage', (e) => {
            if (e.key === 'multiStopwatchData' && manager) {
                console.log('æ£€æµ‹åˆ°å­˜å‚¨æ•°æ®å˜åŒ–ï¼Œé‡æ–°åŠ è½½æ•°æ®...');
                manager.loadData();
                updateDisplay();
                updateActivitySwitcher();
            }
        });


    </script>
</body>
</html> 